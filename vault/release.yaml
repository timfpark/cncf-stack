apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: vault
    namespace: vault
spec:
    releaseName: vault
    chart:
        spec:
            chart: vault
            sourceRef:
                kind: HelmRepository
                name: hashicorp
                namespace: flux-system
            version: "0.6.0"
    interval: 1h0m0s
    install:
        remediation:
            retries: 4
    values:
        global:
            enabled: true

        ui:
            enabled: true
            serviceType: "LoadBalancer"
            serviceNodePort: null
            externalPort: 8200

        server:
            # This configures the Vault Statefulset to create a PVC for audit logs.
            # See https://www.vaultproject.io/docs/audit/index.html to know more
            auditStorage:
                enabled: true

            # Turn on High Availability, use 5 replicas, and Raft for consensus across them.
            standalone:
                enabled: false

            ha:
                enabled: true
                replicas: 5
                raft:
                    enabled: true
                    setNodeId: true

            # These Resource Limits the recommended node requirements in the
            # Vault Reference Architecture for a Small Cluster
            resources:
                requests:
                    memory: 8Gi
                    cpu: 2000m
                limits:
                    memory: 16Gi
                    cpu: 2000m

            # For HA configuration (and because we need to manually initialize the vault),
            # we need to define custom readiness/liveness probe settings per Vault HA guide.
            readinessProbe:
                enabled: true
                path: "/v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204"
            livenessProbe:
                enabled: true
                path: "/v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204"
                initialDelaySeconds: 60
# see https://learn.hashicorp.com/tutorials/vault/getting-started-deploy#initializing-the-vault
